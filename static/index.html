<!DOCTYPE html>
<html>
   <head>
      <meta charset='utf-8'>
      <meta http-equiv='X-UA-Compatible' content='IE=edge'>
      <title>Birthday Artifact</title>
      <meta name='viewport' content='width=device-width, initial-scale=1'>
      <link rel="stylesheet" href="/static/main.css"/>
       <link rel='shortcut icon' type='image/x-icon' href='/static/favicon.ico' />

      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.5.0/cerulean/bootstrap.min.css" integrity="sha256-eMIQtojewNHneFWVpBljYTgfjcw2C2l2UVtitX5J/M4=" crossorigin="anonymous" />
      
      <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js" crossorigin="anonymous"></script>
      <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css" crossorigin="anonymous"/>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha256-OFRAJNoaD8L3Br5lglV7VyLRf0itmoBzWUoM+Sji4/8=" crossorigin="anonymous"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.685.0/aws-sdk.min.js" integrity="sha256-NAe7HYahKIgwXjUHaRe70SBzWDEz0RbrxLmh1lfh+eo=" crossorigin="anonymous"></script>
      <!-- <script src="/static/aws-sdk-2.685.0.min.js"></script> -->
 
      <script src="/static/main.js"></script>
      <link rel="stylesheet" href="/static/main.css">

      <!-- <script src="https://sdk.amazonaws.com/js/aws-sdk-2.685.0.min.js"></script>
      <script src="/static/main.js"></script> -->
   </head>
   <body class="container">
      <div class="jumbotron text-center">
          <h1 class="title">Birthday Charmer</h1>
         <h3 class="bold">Gift Your Friend Some Amazing Birthday Memories!</h3>
      </div>
      <div class="video">
          <video controls autoplay loop>
              <source src="/static/resources/birthday_video.mp4" type="video/mp4">
          </video>
      </div>
      <div class="container-fluid">
          <div class="unilinkDiv" style="display: none;">
              <span>Here is the link to share with your friends - <a href="" id="unilink" style="color: cyan; padding: 5px;"></a></span>
          </div>
          <div class="row justify-content-center thank-you" style="display: none;">
              <div style="align-content: center">
                 <h2>Wohoooooo.....!!</h2>
                  <img src="/static/resources/birthday_bash.gif" align="center">
                  <h2>Your greeting will be ready soon!</h2>
                  <label>If you are excited and would like a early peep-in, click </label>
                  <input type="button" id="send_btn" class="btn btn-primary" title="Send" value="Send">
             </div>
          </div>
         <div class="row">
            <form class="form" id="initial-bday-form" style="display: contents" method="post"  enctype="multipart/form-data">
                <input type="hidden" value="">
               <div class="col float-left" id="left-div">
                   <div class="row">
                        <h1 class="float-left">So, Who's Birthday it is??</h1>
                    </div>
                  <div class="form-group">
                     <label for="bday_name">Full Name</label>
                     <input type="text" class="form-control" id="bday_name" placeholder="Enter Full Name" required>
                  </div>
                  <div class="form-group">
                     <label for="bday_email">Email</label>
                     <input type="text" class="form-control" id="bday_email" placeholder="Email Address" required>
                  </div>
                  <div class="form-group">
                     <label for="bday_date">Birth Date</label>
                     <input type="text" class="form-control" id="bday_date" placeholder="MM/DD/YYYY" required>
                  </div>
                  <div class="form-group">
                      <input type="file" name="fileToUpload" id="bday_photo" data-val="" data-name="" accept="image/gif, image/jpeg, image/png" onchange="genUrlToSave(this)">
                  </div>
                   <div class="form-group">
                       <img id="bday_photo_img" src="/static/resources/user.png" width="150" height="150"/>
                   </div>
               </div>
               <div class="col float-right">
                   <div class="row">
                        <h1 class="float-left">Tell us about you!!</h1>
                    </div>
                  <div class="form-group">
                     <label for="user_name">Your Name</label>
                     <input type="text" class="form-control" id="user_name" placeholder="Enter Your Name" required>
                  </div>
                  <div class="form-group">
                     <label for="user_email">Your Email</label>
                     <input type="text" class="form-control" id="user_email" placeholder="Email Your Address" required>
                  </div>
                   <div class="form-group">
                     <label for="user_greetings">Your Message</label>
                     <input type="text" class="form-control" id="user_greetings" placeholder="Enter your birthday wishes">
                  </div>
                  <div class="form-group">
                      <input type="file" name="fileToUpload" id="user_photo" data-val="" data-name="" accept="image/gif, image/jpeg, image/png" onchange="genUrlToSave(this)">
                  </div>
                   <div class="form-group">
                       <img id="user_photo_img" src="/static/resources/user.png" width="150" height="150"/>
                   </div>
                   <div class="form-group">
                       <input type="button" class="btn btn-primary" id="submitButtonId" title="Submit" value="Submit"/>
                   </div>
               </div>
            </form>
         </div>
      </div>
   </body>

   <script type="text/javascript">
       var image_name;
    //    var server_link = "http://127.0.0.1:5001/";
       var server_link = "";

        function genUrlToSave(thisParameter) {
            var image = $(thisParameter).val().split('fakepath\\').pop();
            var img_name = image.split('.')[0];
            var image_ext = image.split('.')[1];
            var timestamp = new Date($.now()).getTime();
            var album;
            if (window.location.href.indexOf("bday") != -1) {
                album = window.location.href.split("=")[1];
            } else {
                album = $("#bday_email").val().split("@")[0];
            }
            image_name =  img_name + "-" + timestamp + "." + image_ext
            var final_link = "https://birthday-engine.s3-us-west-1.amazonaws.com/" + album + "/" + image_name;
            $(thisParameter).attr("data-val", final_link);
            $(thisParameter).attr("data-name", image_name);

            if (thisParameter.files && thisParameter.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $("#" + thisParameter.id + '_img').attr('src', e.target.result);
                }
                reader.readAsDataURL(thisParameter.files[0]);
            }
        }

        $("#send_btn").click(async function () {
                    //TODO
            console.log("Send button is clicked.")
            let dt = await triggerUrl($("#bday_email").val().split('@')[0] || window.location.href.split("=")[1]);
            console.log(dt['link'])
        });

       $(document).ready(function() {
           if (window.location.href.indexOf("bday") != -1) {
                $("#left-div").hide();
                $("#submitButtonId").click(async function () {
                    var url = server_link+"/bday/" + window.location.href.split("=")[1];

                    let user_name_key = window.location.href.split("=")[1] + '/' + $("#user_email").val().split('@')[0] + "-" + $("#user_photo").attr("data-name")

                    data = await getSignUrl(user_name_key);
                    dx = await uploadPhoto(data.fields.key, data.fields.AWSAccessKeyId, data.fields.policy, data.fields.signature, document.getElementById("user_photo").files[0]);
                    // console.log("value of dx:", dx)
                    if (dx.statusCode == 204) {
                        console.log("User photo uploaded Successfully");
                    } else {
                        console.log("User Photo didn't upload");
                    }

                    resSaved = await saveUserInfo(url, 
                        $("#bday_photo").attr("data-val"), 
                        $("#user_name").val(), $("#user_email").val(), $("#user_greetings").val(),
                        $("#user_photo").attr("data-val")
                    )
                    if (resSaved !== undefined) {
                        console.log(resSaved);
                        if (resSaved.unilink) {
                        $("#initial-bday-form").hide();
                        $(".thank-you").show();
                        }
                    }
                });
            } else {
                    $("#submitButtonId").click(async function () {
                        if ($("#bday_email").val().split('@')[0] !== undefined && $("#bday_email").val().split('@')[0] !== "") {
                            let bday_name_key = $("#bday_email").val().split('@')[0] + '/' + $("#bday_photo").attr("data-name")
                            let user_name_key = $("#bday_email").val().split('@')[0] + '/' + $("#user_email").val().split('@')[0] + "-" + $("#user_photo").attr("data-name")

                            console.log("bday_name_key: ", bday_name_key, ":: user_name_key: ", user_name_key)
                            // data = await getSignUrl($("#bday_photo").attr("data-name"))
                            data = await getSignUrl(bday_name_key)

                            let dx = await uploadPhoto(data.fields.key, data.fields.AWSAccessKeyId, data.fields.policy, data.fields.signature, document.getElementById("bday_photo").files[0])
                            // console.log("value of dx:", dx);
                            if (dx.statusCode == 204) {
                                console.log("Bday photo uploaded Successfully");
                            } else {
                                console.log("Bday Photo didn't upload");
                            }
                            // dx not matter.

                            let usrdata = await getSignUrl(user_name_key);
                            // console.log("Value of usrdata", usrdata);

                            let dy = await uploadPhoto(usrdata.fields.key, usrdata.fields.AWSAccessKeyId, usrdata.fields.policy, usrdata.fields.signature, document.getElementById("user_photo").files[0]);
                            // console.log("value of dy:", dy)
                            if (dy.statusCode == 204) {
                                console.log("User photo uploaded Successfully");
                            } else {
                                console.log("User Photo didn't upload");
                            }

                            resUniqueLink = await getUniqueLink(
                                                    $("#bday_email").val(), $("#bday_name").val(), $("#bday_date").val(), $("#bday_photo").attr("data-val"),
                                                    $("#user_name").val(), $("#user_email").val(), $("#user_greetings").val(), $("#user_photo").attr("data-val")
                                                );

                            if (resUniqueLink !== undefined) {
                                console.log("Found a uniquelink", resUniqueLink);
                                if (resUniqueLink.unilink) {
                                    $(".unilinkDiv").show();
                                    $("#unilink").attr("href", "bday/" + resUniqueLink.unilink);
                                    $("#unilink").text(server_link + resUniqueLink.unilink);
                                    $("#initial-bday-form").hide();
                                    $(".thank-you").show();
                                }
                            }
                        } else {
                            console.log("Please correct the email address of our Birthday person");
                        }
                    });
            }
       });
   </script>
</html>